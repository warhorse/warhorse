events {
  worker_connections 20000;
}

http {
  error_log /etc/nginx/log/error.log warn;
  access_log /etc/nginx/log/access.log;
  client_max_body_size 400m;
  client_body_buffer_size 400M;

  resolver 127.0.0.11 valid=10s;

  set_real_ip_from  10.0.0.0/8;
  set_real_ip_from  172.16.0.0/12;
  set_real_ip_from  192.168.0.0/16;
  real_ip_header    X-Real-IP;

  geo $allow_cdn { 
    4.232.98.120/29 0;
    13.73.248.16/29 0;
    20.21.37.40/29 0;
    20.36.120.104/29 0;
    20.37.64.104/29 0;
    20.37.156.120/29 0;
    20.37.195.0/29 0;
    20.37.224.104/29 0;
    20.38.84.72/29 0;
    20.38.136.104/29 0;
    20.39.11.8/29 0;
    20.41.4.88/29 0;
    20.41.64.120/29 0;
    20.41.192.104/29 0;
    20.42.4.120/29 0;
    20.42.129.152/29 0;
    20.42.224.104/29 0;
    20.43.41.136/29 0;
    20.43.65.128/29 0;
    20.43.130.80/29 0;
    20.45.112.104/29 0;
    20.45.192.104/29 0;
    20.59.103.64/29 0;
    20.72.18.248/29 0;
    20.79.107.152/29 0;
    20.88.157.176/29 0;
    20.90.132.152/29 0;
    20.115.247.64/29 0;
    20.118.195.128/29 0;
    20.119.155.128/29 0;
    20.150.160.96/29 0;
    20.189.106.112/29 0;
    20.192.161.104/29 0;
    20.192.225.48/29 0;
    20.210.70.64/30 0;
    20.215.4.240/29 0;
    20.217.44.240/29 0;
    40.67.48.104/29 0;
    40.74.30.72/29 0;
    40.80.56.104/29 0;
    40.80.168.104/29 0;
    40.80.184.120/29 0;
    40.82.248.248/29 0;
    40.89.16.104/29 0;
    51.12.41.8/29 0;
    51.12.193.8/29 0;
    51.53.30.144/29 0;
    51.104.25.128/29 0;
    51.105.80.104/29 0;
    51.105.88.104/29 0;
    51.107.48.104/29 0;
    51.107.144.104/29 0;
    51.120.40.104/29 0;
    51.120.224.104/29 0;
    51.137.160.112/29 0;
    51.143.192.104/29 0;
    52.136.48.104/29 0;
    52.140.104.104/29 0;
    52.150.136.120/29 0;
    52.159.71.160/29 0;
    52.228.80.120/29 0;
    68.221.93.128/29 0;
    102.133.56.88/29 0;
    102.133.216.88/29 0;
    147.243.0.0/16 0;
    158.23.108.56/29 0;
    191.233.9.120/29 0;
    191.235.225.128/29 0;
    120.52.22.96/27 0;
    205.251.249.0/24 0;
    180.163.57.128/26 0;
    204.246.168.0/22 0;
    205.251.252.0/23 0;
    54.192.0.0/16 0;
    204.246.173.0/24 0;
    54.230.200.0/21 0;
    120.253.240.192/26 0;
    116.129.226.128/26 0;
    130.176.0.0/17 0;
    108.156.0.0/14 0;
    99.86.0.0/16 0;
    205.251.200.0/21 0;
    223.71.71.128/25 0;
    13.32.0.0/15 0;
    120.253.245.128/26 0;
    13.224.0.0/14 0;
    70.132.0.0/18 0;
    15.158.0.0/16 0;
    13.249.0.0/16 0;
    205.251.208.0/20 0;
    65.9.128.0/18 0;
    130.176.128.0/18 0;
    58.254.138.0/25 0;
    54.230.208.0/20 0;
    116.129.226.0/25 0;
    52.222.128.0/17 0;
    64.252.128.0/18 0;
    205.251.254.0/24 0;
    54.230.224.0/19 0;
    71.152.0.0/17 0;
    216.137.32.0/19 0;
    204.246.172.0/24 0;
    120.52.39.128/27 0;
    118.193.97.64/26 0;
    223.71.71.96/27 0;
    54.240.128.0/18 0;
    205.251.250.0/23 0;
    180.163.57.0/25 0;
    52.46.0.0/18 0;
    223.71.11.0/27 0;
    52.82.128.0/19 0;
    54.230.0.0/17 0;
    54.230.128.0/18 0;
    54.239.128.0/18 0;
    130.176.224.0/20 0;
    36.103.232.128/26 0;
    52.84.0.0/15 0;
    143.204.0.0/16 0;
    144.220.0.0/16 0;
    120.52.153.192/26 0;
    119.147.182.0/25 0;
    120.232.236.0/25 0;
    54.182.0.0/16 0;
    58.254.138.128/26 0;
    120.253.245.192/27 0;
    54.239.192.0/19 0;
    18.64.0.0/14 0;
    120.52.12.64/26 0;
    99.84.0.0/16 0;
    130.176.192.0/19 0;
    52.124.128.0/17 0;
    204.246.164.0/22 0;
    13.35.0.0/16 0;
    204.246.174.0/23 0;
    36.103.232.0/25 0;
    119.147.182.128/26 0;
    118.193.97.128/25 0;
    120.232.236.128/26 0;
    204.246.176.0/20 0;
    65.8.0.0/16 0;
    65.9.0.0/17 0;
    108.138.0.0/15 0;
    120.253.241.160/27 0;
    64.252.64.0/18 0;
    default 1;
  }

  server {
    server_name {% raw %}{{ ansible_host }}{% endraw %};
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/{% raw %}{{ domain_name }}{% endraw %}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{% raw %}{{ domain_name }}{% endraw %}/privkey.pem;
    ssl_session_timeout 1440m;
    ssl_session_cache shared:le_nginx_SSL:1m;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
    ssl_prefer_server_ciphers on;
    add_header Strict-Transport-Security max-age=15768000;
    ssl_stapling on;
    ssl_stapling_verify on;

    location / {
      rewrite ^ https://{% raw %}{{ redirect_url }}{% endraw %};
    }
  
  }
{% for vm in warhorse.vm %}
{% if vm.evilginx2 is defined %}
  server {
    server_name {% for host in vm.evilginx2.nginx_hostnames %}{{ host }}.{{ vm.evilginx2.evilginx_domain }} {% endfor %};
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/{% raw %}{{ domain_name }}{% endraw %}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{% raw %}{{ domain_name }}{% endraw %}/privkey.pem;
    ssl_session_timeout 1440m;
    ssl_session_cache shared:le_nginx_SSL:1m;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
    ssl_prefer_server_ciphers on;
    add_header Strict-Transport-Security max-age=15768000;
    ssl_stapling on;
    ssl_stapling_verify on;

    proxy_busy_buffers_size   512k;
    proxy_buffers   4 512k;
    proxy_buffer_size   256k;
    fastcgi_buffers  16 16k;
    fastcgi_buffer_size  32k;

    location / {
      resolver 127.0.0.11 valid=10s;
      proxy_ssl_server_name on;
      proxy_ssl_name $host;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP "";
      proxy_set_header X-Forwarded-For "";
      proxy_set_header X-Forwarded-Proto "";
      proxy_set_header X-Forwarded-Host "";
      proxy_set_header X-Azure-Socketip "";
      proxy_set_header X-Azure-Requestchain "";
      proxy_set_header X-Azure-Ref "";
      proxy_set_header X-Azure-Ipdetection "";
      proxy_set_header X-Azure-Fdid "";
      proxy_set_header X-Azure-Clientip "";
      proxy_set_header Via "";
      proxy_set_header X-Msedge-Ignoreratelimits "";
      proxy_ssl_protocols  TLSv1 TLSv1.1 TLSv1.2; 
      proxy_ssl_verify off;
      proxy_pass https://evilginx2:443;
    }
  }
{% endif %}
{% if vm.gophish is defined %}
  server {
    server_name {{ vm.gophish.admin_hostname }}.{% raw %}{{ domain_name }}{% endraw %};
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/{% raw %}{{ domain_name }}{% endraw %}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{% raw %}{{ domain_name }}{% endraw %}/privkey.pem;
    ssl_session_timeout 1440m;
    ssl_session_cache shared:le_nginx_SSL:1m;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
    ssl_prefer_server_ciphers on;
    add_header Strict-Transport-Security max-age=15768000;
    ssl_stapling on;
    ssl_stapling_verify on;

    location / {
      proxy_ssl_server_name on;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_pass http://gophish:3333;
      allow {{ vm.gophish.white_list_ip }};
      deny all;
    }
  }
  server {
    server_name {{ vm.gophish.site_hostname }}.{% raw %}{{ domain_name }}{% endraw %};
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/{% raw %}{{ domain_name }}{% endraw %}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{% raw %}{{ domain_name }}{% endraw %}/privkey.pem;
    ssl_session_timeout 1440m;
    ssl_session_cache shared:le_nginx_SSL:1m;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
    ssl_prefer_server_ciphers on;
    add_header Strict-Transport-Security max-age=15768000;
    ssl_stapling on;
    ssl_stapling_verify on;

    location / {
      proxy_ssl_server_name on;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $remote_addr;
      proxy_pass http://gophish:80;
    }
  }
{% endif %}
{% if vm.nighthawk is defined %}
  server {
    server_name {% raw %}{{ nighthawk_site_hostname }}.{{ domain_name }}{% endraw %};
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/{% raw %}{{ domain_name }}{% endraw %}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{% raw %}{{ domain_name }}{% endraw %}/privkey.pem;
    ssl_session_timeout 1440m;
    ssl_session_cache shared:le_nginx_SSL:1m;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
    ssl_prefer_server_ciphers on;
    add_header Strict-Transport-Security max-age=15768000;
    ssl_stapling on;
    ssl_stapling_verify on;

    location / {
      proxy_ssl_server_name on;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For "$http_x_forwarded_for, $realip_remote_addr";
      proxy_pass https://{% raw %}{{ nighthawk_container_name }}/{% endraw %};
{% if vm.cobaltstrike.cdn is defined %}
      if ( $allow_cdn = 1 ) { return 403; }
{% endif %}
    }
  }
{% endif %}
{% if vm.cobaltstrike is defined %}
  server {
    server_name {% raw %}{{ cs_site_hostname }}.{{ domain_name }}{% endraw %};
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/{% raw %}{{ domain_name }}{% endraw %}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{% raw %}{{ domain_name }}{% endraw %}/privkey.pem;
    ssl_session_timeout 1440m;
    ssl_session_cache shared:le_nginx_SSL:1m;
    ssl_session_tickets off;
    ssl_protocols TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
    ssl_prefer_server_ciphers on;
    add_header Strict-Transport-Security max-age=15768000;
    ssl_stapling on;
    ssl_stapling_verify on;

    location / {
      proxy_ssl_server_name on;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For "$http_x_forwarded_for, $realip_remote_addr";
      proxy_pass https://{% raw %}{{ cs_container_name }}/{% endraw %};
{% if vm.cobaltstrike.cdn is defined %}
      if ( $allow_cdn = 1 ) { return 403; }
{% endif %}
    }
  }
{% endif %}
{% endfor %}
}